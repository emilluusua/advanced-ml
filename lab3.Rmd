---
title: "Lab 3"
author: "Emil Luusua"
date: "4 October 2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(12)
```

## Question 1
We start by defining functions that sample the transition, emission and initial models. The functions rnorm and runif are used to sample from normal/uniform distributions. For the mixture models each component is sampled, and then one of these samples are chosen at random. The standard deviation of the emission model (sd) is taken as an argument to ease in question 2.
```{r}
transition_model <- function(prev) {
  components <- c(rnorm(1, prev, 1), rnorm(1, prev + 1, 1), rnorm(1, prev + 2, 1))
  return(sample(components, 1))
}

emission_model <- function(pos, sd) {
  components <- c(rnorm(1, pos, sd), rnorm(1, pos - 1, sd), rnorm(1, pos + 1, sd))
  return(sample(components, 1))
}

initial_model <- function() {
  return(runif(1, 0, 100))
}
```

We also implement a function that evaluates the probability density function of the emission model which can be used to compute the weights of the particle filter. This is done by evaluating the densities of each component and then taking the average.
```{r}
emission_density <- function(obs, pos, sd) {
  components <- c(dnorm(obs, pos, sd), dnorm(obs, pos - 1, sd), dnorm(obs, pos + 1, sd))
  return(mean(components))
}
```

We implement a function which performs a simulation of the state space model for 100 time steps and run it with standard deviation set to 1.
```{r}
simulate_SSM <- function(sd) {
  T <- 100
  
  initial_pos <- initial_model()
  initial_obs <- emission_model(initial_pos, sd)
  
  res <- list()
  res$states <- rep(initial_pos, 100)
  res$observation <- rep(initial_obs, 100)
  
  for (t in 2:T) {
    res$states[t] <- transition_model(res$states[t-1])
    res$observation[t] <- emission_model(res$states[t], sd)
  }
  return(res)
}

simulation <- simulate_SSM(1)
print(simulation)
```

Next we implement the particle filter using 100 particles. The version presented by Thrun et al. in *Probabilistic Robotics* is utilized. The option of using weights for correction and the standard deviation is taken as arguments to ease in questions 2 and 3. The functions returns the belief particles at each time step.
```{r}
particle_filter <- function(observations, sd, use_weights) {
  # Constants
  T <- 100
  M <- 100
  
  # Initialize variables
  particles <- matrix(rep(0, T * M), ncol = M)
  bel <- rep(0, M)
  bel_bar <- rep(0, M)
  w <- rep(1, M)
  
  # Generate initial particles
  for(m in 1:M) {
    bel[m] <- initial_model()
  }
  
  for(t in 1:T) {
    for(m in 1:M) {
      bel_bar[m] <- transition_model(bel[m])
      
      if(use_weights) {
        w[m] <- emission_density(observations[t], bel_bar[m], sd)
      }
    }
    
    bel <- sample(bel_bar, M, replace = TRUE, prob = w)
    particles[t, ] <- bel
  }
  
  return(particles)
}
```

We apply the particle filter to our simulated observations and show the particles, their mean (the expected location) and the true location at time steps $t = 1, 34, 67, 100$.
```{r}
particles <- particle_filter(simulation$observation, 1, TRUE)
```

Particles at $t = 1$:
```{r echo=FALSE}
print(particles[1, ])
```
Expected location at $t = 1$: `r mean(particles[1, ])`  
True location at $t = 1$: `r simulation$states[1]`

Particles at $t = 34$:
```{r echo=FALSE}
print(particles[34, ])
```
Expected location at $t = 34$: `r mean(particles[34, ])`  
True location at $t = 34$: `r simulation$states[34]`

Particles at $t = 67$:
```{r echo=FALSE}
print(particles[67, ])
```
Expected location at $t = 67$: `r mean(particles[67, ])`  
True location at $t = 67$: `r simulation$states[67]`

Particles at $t =100$:
```{r echo=FALSE}
print(particles[100, ])
```
Expected location at $t = 100$: `r mean(particles[100, ])`  
True location at $t = 100$: `r simulation$states[100]`

## Question 2
We now apply the same procedure, using standard deviations 5 and 50. The results are presented below, and unsurprisingly the conclusion is that the higher degree of variance in our observations cause the model to make more inaccurate predictions.

#### Standard deviation of 5
```{r}
sd <- 5
simulation <- simulate_SSM(sd)
particles <- particle_filter(simulation$observation, sd, TRUE)
```

Particles at $t = 1$:
```{r echo=FALSE}
print(particles[1, ])
```
Expected location at $t = 1$: `r mean(particles[1, ])`  
True location at $t = 1$: `r simulation$states[1]`

Particles at $t = 34$:
```{r echo=FALSE}
print(particles[34, ])
```
Expected location at $t = 34$: `r mean(particles[34, ])`  
True location at $t = 34$: `r simulation$states[34]`

Particles at $t = 67$:
```{r echo=FALSE}
print(particles[67, ])
```
Expected location at $t = 67$: `r mean(particles[67, ])`  
True location at $t = 67$: `r simulation$states[67]`

Particles at $t =100$:
```{r echo=FALSE}
print(particles[100, ])
```
Expected location at $t = 100$: `r mean(particles[100, ])`  
True location at $t = 100$: `r simulation$states[100]`

#### Standard deviation of 50
```{r}
sd <- 50
simulation <- simulate_SSM(sd)
particles <- particle_filter(simulation$observation, sd, TRUE)
```

Particles at $t = 1$:
```{r echo=FALSE}
print(particles[1, ])
```
Expected location at $t = 1$: `r mean(particles[1, ])`  
True location at $t = 1$: `r simulation$states[1]`

Particles at $t = 34$:
```{r echo=FALSE}
print(particles[34, ])
```
Expected location at $t = 34$: `r mean(particles[34, ])`  
True location at $t = 34$: `r simulation$states[34]`

Particles at $t = 67$:
```{r echo=FALSE}
print(particles[67, ])
```
Expected location at $t = 67$: `r mean(particles[67, ])`  
True location at $t = 67$: `r simulation$states[67]`

Particles at $t =100$:
```{r echo=FALSE}
print(particles[100, ])
```
Expected location at $t = 100$: `r mean(particles[100, ])`  
True location at $t = 100$: `r simulation$states[100]`

## Question 3
We repeat the procedure one final time, with correction weights disabled. This performs significantly worse, since it means that we do not take our observations into account at all. So basically the particle filter just performs another simulation, independent of our observations.

```{r}
sd <- 1
simulation <- simulate_SSM(sd)
particles <- particle_filter(simulation$observation, sd, FALSE)
```

Particles at $t = 1$:
```{r echo=FALSE}
print(particles[1, ])
```
Expected location at $t = 1$: `r mean(particles[1, ])`  
True location at $t = 1$: `r simulation$states[1]`

Particles at $t = 34$:
```{r echo=FALSE}
print(particles[34, ])
```
Expected location at $t = 34$: `r mean(particles[34, ])`  
True location at $t = 34$: `r simulation$states[34]`

Particles at $t = 67$:
```{r echo=FALSE}
print(particles[67, ])
```
Expected location at $t = 67$: `r mean(particles[67, ])`  
True location at $t = 67$: `r simulation$states[67]`

Particles at $t =100$:
```{r echo=FALSE}
print(particles[100, ])
```
Expected location at $t = 100$: `r mean(particles[100, ])`  
True location at $t = 100$: `r simulation$states[100]`